name: Laravel CI CD  # Name of the workflow, shown in GitHub Actions

on:
  push:
    branches: [ main ]  # Trigger workflow only on push to main branch

jobs:
  ci-cd:
    runs-on: ubuntu-latest  # Use a temporary Ubuntu VM provided by GitHub

    steps:
      # ---------- CI (Continuous Integration) ----------
      - name: Checkout code
        uses: actions/checkout@v4  # Clone your GitHub repository into runner

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.3  # Install PHP 8.3 on the runner
          extensions: mbstring, pdo, pdo_mysql  # Enable Laravel required extensions

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist
        # Install all PHP packages from composer.json into vendor/
        # --no-interaction avoids prompts, --prefer-dist speeds up download

      - name: Prepare Laravel
        run: php artisan key:generate --show  # Only generate key if missing

      - name: Run tests
        run: php artisan test  # Run all Laravel PHPUnit tests
        # If tests fail, workflow stops and deployment will NOT happen

      # ---------- CD (Continuous Deployment) ----------
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh  # Create SSH directory if it doesn't exist
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          # Save private key from GitHub Secrets
          chmod 600 ~/.ssh/id_ed25519  # Restrict permissions
          ssh-keyscan ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
          # Add server fingerprint to known_hosts to avoid confirmation prompt

      - name: Deploy to Production Server
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
            cd /var/www/html/SOB-eorder  # Change directory to your Laravel project on server
            git pull origin main  # Pull latest code from GitHub
            composer install --no-dev --optimize-autoloader
            # Install production dependencies only, optimize autoload files
            php artisan migrate --force  # Run database migrations in production
            php artisan optimize  # Cache config/routes/views for better performance
          EOF  # End of SSH session
